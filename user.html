<!DOCTYPE html>
<html lang="en">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        #wraper {
            width: 1000px;
            height: 500px;
            margin: auto;

        }

        #header {
            width: 1000px;
            height: 20%;
            background-color: #2bb3c0;
            position: fixed;
            clear: both;
            top: 0px;
        }

        #friend {
            height: 100%;
            width: 180px;
            background-color: #999999;
            float: left;
            position: fixed;
            top: 21%;
            left: 171px;
        }

        #timeline {
            margin-top: 20%;
            padding: 20px;
            height: 100%;
            width: 600px;
            float: left;
            position: absolute;
            left: 350px;
        }

        #alert {
            height: 100%;
            width: 180px;
            background-color: #999999;
            float: left;
            position: fixed;
            top: 21%;
            right: 170px;
        }
    </style>
</head>
<body>
<div id="wraper">
    <div id="header">
        <table>
            <tr>
                <td>
                    <input type="text" placeholder="Nhập email của bạn bè" id="email">
                </td>
                <td>
                    <button onclick="searchFriend()">Tìm kiếm</button>
                </td>
            </tr>
            <tr>
                <td>
                    <div id="refriend"></div>
                </td>
            </tr>
        </table>
        <div id="posts">
            <div id="uploadfile"></div>
            <input id="content" type="text" placeholder="Bạn đang nghĩ gì?">
            <select name="" id="privacy">
                <option value="onlyme">only me</option>
                <option value="friend">friend</option>
                <option value="public">public</option>
            </select>
            <input type="file" value="upload" accept=".jpg" id="fileButton">
            <input type="hidden" id="image">
            <button onclick="post()">post</button>
        </div>

    </div>
    <div id="friend">

    </div>
    <div id="timeline">
        <input type="hidden" id="page" value=0>
    </div>
    <div id="alert">

    </div>
</div>
<script>
    $(document).ready(function () {
        getListPost();
    })

    function searchFriend() {
        let email = $('#email').val();
        let account = {email: email};
        $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'Authorization': window.sessionStorage.getItem('TOKEN_KEY')
            },
            data: JSON.stringify(account),
            type: "POST",
            url: 'http://localhost:8080/user/searchfriend',
            success: function (data) {
                let result = ""
                result +=
                    '<table><tr>' +
                    '<td><img width="50px" height="50px" src=' + data.avatar.path + '/></td>' +
                    '<td><p>' + data.fullName + '</p></td>' +
                    '<td><button type="button"  id="continueshow" onclick="addFriend(' + data.id + ')"> Gửi kết bạn </button></td>' +
                    '</tr></table>';

                document.getElementById('refriend').innerHTML = result;
            },
            error: function () {
                let result = '<p>Không tìm thấy</p>';
                document.getElementById('refriend').innerHTML = result;
            }
        })
    }

    function addFriend(idFriend) {
        let idAcc = window.sessionStorage.getItem('ID_KEY');
        $.ajax({
            url: 'http://localhost:8080/user/sendaddfriend/' + idAcc + '/' + idFriend,
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'Authorization': window.sessionStorage.getItem('TOKEN_KEY')
            },
            success: function () {
                document.getElementById('refriend').innerHTML = "";
            },
            error: function () {
                document.getElementById('refriend').innerHTML = "";
            }
        })
        event.preventDefault();
    }

    function getListPost() {
        let page = $('#page').val();
        $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'Authorization': window.sessionStorage.getItem('TOKEN_KEY')
            },
            data: page,
            type: "POST",
            url: 'http://localhost:8080/user/timeline',
            success: function (data) {
                showPost(data);
            }
        })
        event.preventDefault();
    }

    function showPost(data) {
        let resulf = "";
        if (data.content.length > 0) {
            document.getElementById("page").value = data.number + 1;
            $('#continueshow').remove();
            for (let i = 0; i < data.content.length; i++) {
                console.log(data.content[i].content);
                let tabe = '<table><tr><td></td><td><p>' + data.content[i].likeList.length + '</p></td><td></td><td> <p>' + data.content[i].commentList.length + '</p></td></tr></table>'
                resulf += '<div id="post' + data.content[i].id + '">' +
                    '<p>' + data.content[i].account.fullName + '</p>' +
                    '<p>' + data.content[i].privacy + '</p>' +
                    '<p><img width="560px" height="auto" src=' + data.content[i].imageList[0].path + '/></p>' +
                    '<table><tr><td><p>' + data.content[i].likeList.length + '</p></td><td>Like</td><td> <p>' + data.content[i].commentList.length + '</p></td><td>Bình luận</td></tr></table>' +
                    '<button type="button" onclick="createLike(' + data.content[i].id + ')"> Like </button>' +
                    '<input type="text" id="comment' + data.content[i].id + '"/>' +
                    '<button type="button" onclick="createCm(' + data.content[i].id + ')"> Bình luận </button>';
                for (let j = 0; j < data.content[i].commentList.length; j++) {
                    resulf += '<p>' + data.content[i].commentList[j].account.fullName + '</p>' +
                        '<p>' + data.content[i].commentList[j].content + '</p>';
                    if (data.content[i].commentList[j].account.id == window.sessionStorage.getItem('ID_KEY')) {
                        resulf += '<button type="button" onclick="deleteComment(' + data.content[i].commentList[j].id + ',' + data.content[i].id + ')"> Xóa </button>';
                    }
                }
                resulf += '</div>';
            }
            resulf += '<button type="button"  id="continueshow" onclick="continuePost()"> Xem Thêm </button>';
        }

        let divLocation = document.getElementById("timeline");
        let element = document.createElement("div");
        element.innerHTML = resulf;
        divLocation.append(element);
    }

    function continuePost() {
        getListPost();
    }

    function deleteComment(idComment, idPost) {
        $.ajax({
            url: 'http://localhost:8080/user/deletecomment/' + idComment,
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'Authorization': window.sessionStorage.getItem('TOKEN_KEY')
            },
            success: function () {
                showRePost(idPost);
            },
            error: function () {
                showRePost(idPost);
            }
        })
        event.preventDefault();
    }

    function createLike(idPost) {
        let idAcc = window.sessionStorage.getItem('ID_KEY');
        $.ajax({
            url: 'http://localhost:8080/user/likeshow/' + idAcc + '/' + idPost,
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'Authorization': window.sessionStorage.getItem('TOKEN_KEY')
            },
            dataType: 'json',
            success: function () {
                showRePost(idPost);
            },
            error: function () {
                showRePost(idPost);
            }
        })
        event.preventDefault();
    }

    function showRePost(idPost) {
        $.ajax({
            url: 'http://localhost:8080/user/findPost/' + idPost,
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'Authorization': window.sessionStorage.getItem('TOKEN_KEY')
            },
            success: function (data) {
                let result = '<p>' + data.account.fullName + '</p>' +
                    '<p>' + data.privacy + '</p>' +
                    '<p><img width="560px" height="auto" src=' + data.imageList[0].path + '/></p>' +
                    '<table><tr><td><p>' + data.likeList.length + '</p></td><td>Like</td><td><p>' + data.commentList.length + '</p></td><td>Bình luận</td></tr></table>' +
                    '<button type="button" onclick="createLike(' + data.id + ')"> Like </button>' +
                    '<input type="text" id="comment' + data.id + '"/>' +
                    '<button type="button" onclick="createCm(' + data.id + ')"> Bình luận </button>';
                for (let j = 0; j < data.commentList.length; j++) {
                    result += '<p>' + data.commentList[j].account.fullName + '</p>' +
                        '<p>' + data.commentList[j].content + '</p>';
                    if (data.commentList[j].account.id == window.sessionStorage.getItem('ID_KEY')) {
                        result += '<button type="button" onclick="deleteComment(' + data.commentList[j].id + ',' + data.id + ')"> Xóa </button>';
                    }
                }
                document.getElementById("post" + idPost).innerHTML = result;
            }
        })
    }

    function createCm(idPost) {
        let idAcc = window.sessionStorage.getItem('ID_KEY');
        let contentNew = document.getElementById('comment' + idPost).value;
        let comment = {content: contentNew};
        $.ajax({
            url: 'http://localhost:8080/user/comment/' + idAcc + '/' + idPost,
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'Authorization': window.sessionStorage.getItem('TOKEN_KEY')
            },
            data: JSON.stringify(comment),
            success: function () {
                showRePost(idPost);
            },
            error: function () {
                showRePost(idPost);
            }
        })
    }

    const firebaseConfig = {
        apiKey: "AIzaSyAW8VF35-_YFnNNBMT9RAjzCHj-SUqR8Uw",
        authDomain: "filebase-70567.firebaseapp.com",
        projectId: "filebase-70567",
        storageBucket: "filebase-70567.appspot.com",
        messagingSenderId: "370746607348",
        appId: "1:370746607348:web:b17a663c94df4db78c00a1",
        measurementId: "G-8VZX3F9WF8"
    };
    firebase.initializeApp(firebaseConfig);
    let fbBucketName = 'images';
    let fileButton = document.getElementById('fileButton');
    fileButton.addEventListener('change', function (e) {
        let file = e.target.files[0];
        let storageRef = firebase.storage().ref(`${fbBucketName}/${file.name}`);
        let uploadTask = storageRef.put(file);
        uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED,
            function (snapshot) {
                switch (snapshot.state) {
                    case firebase.storage.TaskState.PAUSED: // or 'paused'
                        break;
                    case firebase.storage.TaskState.RUNNING: // or 'running'
                        break;
                }
            },
            function (error) {
                switch (error.code) {
                    case 'storage/unauthorized':
                        break;
                    case 'storage/canceled':
                        break;
                    case 'storage/unknown':
                        break;
                }
            }, function () {
                let downloadURL = uploadTask.snapshot.downloadURL;

                document.getElementById("uploadfile").innerHTML = '<img width="100px" height="auto" src=' + downloadURL + '/>';
                document.getElementById("image").value = downloadURL;
            });
    });

    function post() {
        let content = $('#content').val();
        let privacy = $('#privacy').val();
        let timePost = new Date();
        let img = $('#image').val();
        let account = {id: window.sessionStorage.getItem('ID_KEY')}
        let post = {content: content, privacy: privacy, timePost: timePost, account: account}
        let image = {path: img, post: post}

        $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'Authorization': window.sessionStorage.getItem('TOKEN_KEY')
            },
            type: "POST",
            data: JSON.stringify(image),
            //tên API
            url: "http://localhost:8080/user/createPost",
            //xử lý khi thành công
            success: function (data) {
                document.getElementById("uploadfile").value = "";
                document.getElementById("content").value = "";
                document.getElementById("privacy").value = "";
                document.getElementById("image").value = "";
                window.location.reload();
            }
        })
        event.preventDefault();
    }
</script>
</body>
</html>